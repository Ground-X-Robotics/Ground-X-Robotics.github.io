<html>

<head>

<meta charset="utf-8"/>
<meta property="og:image" content="https://pi-calculator.netlify.app/pi_thumb.png">
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML">
</script>


<script type="text/javascript">

var timerid;

function indexes(source, find) {
  var result = [];
  var pos = 0;
  var i = -1;
  
  while (pos != -1) {
    pos = source.indexOf(find, i + 1);
	if (pos > -1)
		result.push(pos);
    i = pos;
  }
  return result;
}
     
function gcd_euclid(a,b) {
    if (a<0) a = -a;
    if (b<0) b = -b;
    if (b > a) {var temp = a; a = b; b = temp;}
    while (true) {
        if (b == 0) return a;
        a %= b;
        if (a == 0) return b;
        b %= a;
    }
}


function pell_sqrt_10005(digits){
	// rational approximation to sqrt(10005) using pell equation
	// use the previous 2 solutions to form the next solution in a Fibonacci style sequence
	// so the values of x,y increase by a factor of approx. the golden ratio each iteration
	D=10005n;
	[x1,y1] = [1n,0n];
	[x2,y2] = [4001n,40n];
	y_target = 10n**(BigInt(digits/2 + 5));

	while (1){
		[x,y] = [x1*x2 + D*y1*y2, x1*y2 + y1*x2];
		if ( y > y_target)
			return [x,y];

		[x1,y1] = [x2,y2];
		[x2,y2] = [x,y];
	}
}


const C = 640320n;
const C3_OVER_24 = (C*C*C) / 24n;
hexchars = 0n;
hexdigits = 0;


function  bs(a, b, level, factoring){
//console.log("calling bs ",a,",",b,", level=",level);
	/*
	Computes the terms for binary splitting the Chudnovsky infinite series

	a(a) = +/- (13591409 + 545140134*a)
	p(a) = (6*a-5)*(2*a-1)*(6*a-1)
	b(a) = 1
	q(a) = a*a*a*C3_OVER_24

	returns P(a,b), Q(a,b) and T(a,b)
	*/
	if (b - a == 1n) {
		// Directly compute P(a,a+1), Q(a,a+1) and T(a,a+1)
		let Pab = 1n;
		let Qab = 1n;
		if (a != 0n){
			 Pab = (6n*a-5n)*(2n*a-1n)*(6n*a-1n);
			 Qab = a*a*a*C3_OVER_24;
		}
		let Tab = Pab * (13591409n + 545140134n*a); // a(a) * p(a)
		if (a & 1n)
			Tab = -Tab;
		return [Pab, Qab, Tab];
	}
	else {
		// Recursively compute P(a,b), Q(a,b) and T(a,b)
		// m is the midpoint of a and b
		let m = (a + b)>>1n;
		let [Pam, Qam, Tam] = bs(a, m, level+1, factoring); 
		let [Pmb,Qmb,Tmb] = bs(m, b, level+1, factoring);

		if (factoring)
			if (b-a > 20n){
				let g = gcd_euclid(Pam,Qmb);
				Pam /= g;
				Qmb /= g;
				//console.log( "a=",a," b=",b," g=",g);
			}
		// Now combine
		let Pab = Pam * Pmb;
		let Qab = Qam * Qmb;
		let Tab = Qmb * Tam + Pam * Tmb;

		return [Pab, Qab, Tab];
	}
}

	  
function pi_chudnovsky_bs(digits, factoring){
	console.log("pi_chudnovsky_bs ",digits);
    //    Compute int(pi * 10**digits) using Chudnovsky's series with binary splitting

    // how many terms to compute
    DIGITS_PER_TERM = Math.log10( (640320**3) / (6*2*6*24) );
    N = Math.floor(digits/DIGITS_PER_TERM + 10);
    // Calclate P(0,N) and Q(0,N)
    [P, Q, T] = bs(0n, BigInt(N), 1, factoring);
    [x,y] = pell_sqrt_10005( digits )
	hexdigits = Math.floor(digits/1.20411998266)
	hexchars = (Q * 426880n * x * (16n**(BigInt(hexdigits)+20n)) ) / (T*y);
	return (Q * 426880n * x * 10n**BigInt(digits)) / (T*y);
}

function pi_chudnovsky(digits){
  //Calculate pi using Chudnovsky's series
  //This calculates it in fixed point
 one = 0n;
 one = 10n**(BigInt(digits)+20n);
  k = 1n;
  a_k = one;
  a_sum = one;
  b_sum = 0n;
  //C = 640320n;
  //C3_OVER_24 = (C*C*C) / 24n; 
  while (1){
    a_k *= -(6n*k-5n)*(2n*k-1n)*(6n*k-1n);
    a_k /= k*k*k*C3_OVER_24;
    a_sum += a_k;
    b_sum += k * a_k;
    k += 1n;
    if (a_k == 0n)
        break;
	}
	total = 13591409n*a_sum + 545140134n*b_sum;

	[x,y] = pell_sqrt_10005( digits );
	hexdigits = Math.floor(digits/1.20411998266)
	hexchars = (426880n*x*one*(16n**(BigInt(hexdigits)+20n))) / (total*y);
	pi = (426880n*x*one*one) / (total*y);
	return pi;
}

function CalculatePi(mode)
{
	var e = document.getElementById("selectNumDigits");
	var value = e.options[e.selectedIndex].value;
	var text = e.options[e.selectedIndex].text;

	digits = value;
	
	//try{
	start = Date.now();
	if (mode==1)
		pi = pi_chudnovsky(digits);
	else if (mode==2)
		pi = pi_chudnovsky_bs(digits, false);
	else if (mode==3)
		pi = pi_chudnovsky_bs(digits, true);
		
	end = Date.now();

	s = pi.toString().slice(0,digits);
	
	s_hex = hexchars.toString(16).slice(hexdigits+1,hexdigits+11);
	
	pretty_pi = (end-start).toString() + "ms for "+digits+" decimal digits. " +
		", Hex digits from postion "+ hexdigits.toString() +" are: "+ s_hex +" (for checking against <a href='https://en.wikipedia.org/wiki/Bailey%E2%80%93Borwein%E2%80%93Plouffe_formula' target='_blank'>BBP</a>)<br>";
	pretty_pi += "<code><pre>" + s[0]+"."+s.slice(1,100) ;

	for (i=100;i<s.length; i+=100){
		sixes = indexes(s.slice(i-2,i+102),'666');
		if ( !sixes.length )
			pretty_pi += "<br>"+s.slice(i,i+100);
		else{
			// remove overlapping sixes
			for (k=sixes.length-1; k>0; k--)
				if ( sixes[k] - sixes[k-1] < 3)
					sixes.splice(k,1);
			
			//console.log("sixes at positions", i, sixes);
			//console.log( s.slice(i-2,i+102) );
			line = "";
			pretty_pi += "<br>" + s.slice(i, i+sixes[0] -2 );
			for (j = 0; j < sixes.length; j++) { 
				pos=sixes[j]; 
						
				if (pos<2){
					pretty_pi += '<b><font color="red">'+ s.slice(i,i+pos+1) + "</font></b>";
					pretty_pi += s.slice(i+pos+1, (j<sixes.length-1) ? i+sixes[j+1]-2 : i+100);
					}
				else if (pos>99){
					pretty_pi += '<b><font color="red">' + s.slice(i+pos-2,i+100)+ "</font></b>";
					}
				else {
					pretty_pi += '<b><font color="red">' + s.slice(i+pos-2,i+pos+1) + "</font></b>";
					pretty_pi += s.slice(i+pos+1, (j<sixes.length-1) ? i+sixes[j+1]-2 : i+100);
					}	
		
			}
		}
	}
	pretty_pi += "</pre></code>";	
	document.getElementById("divPiDigits").innerHTML = pretty_pi;
	/*
	}
	
	catch(error){
	document.getElementById("divPiDigits").innerHTML = error.message;
	}
	*/
 }

function go(mode){
	document.getElementById("divPiDigits").innerHTML = "Please wait, calculating &pi; to " +
		document.getElementById("selectNumDigits").value + " decimal digits using ";
		switch (mode){
			case 1:
			document.getElementById("divPiDigits").innerHTML += "Chudnovsky series";
			break;
			case 2:
			document.getElementById("divPiDigits").innerHTML += "Chudnovsky with binary splitting";
			break;
			case 3:
			document.getElementById("divPiDigits").innerHTML += "Chudnovsky with binary splitting and factoring";
			break;
		}
		document.getElementById("divPiDigits").innerHTML += "....";
	timerid = setTimeout(CalculatePi,30,mode);
	}
</script>

</head>
  <body>
   <h2> Calculate  &pi; using Chudnovsky algorithm and Pell equation </h2>
   <br>
  


  $$ \frac{1}{\pi } = \frac{1}{426880\sqrt{10005}} \sum_{k=0}^{\infty}\frac{(-1)^k(6k)!(13591409 + 545140134k)}{(3k)!(k!)^3 640320^{3k} )} $$


<p>
<table  border="0" cellspacing="2" cellpadding="2">
<tbody>

<tr>
<td valign="bottom">Decimal digits:
</td>

<td valign="bottom"; width=120;><center>Chudnovsky <br>Binary Splitting <br>with factoring<br>
and Pell</center>
</td>
</tr>

<tr>
<td valign="top">
<select id="selectNumDigits" style="background-color:#d9ffb3; font-weight:bold;>
    <option value="50" selected>50</option>
    <option value="100">100</option>
    <option value="1000">1000</option>
    <option value="5000">5000</option>
   <option value="10000">10000</option>
   <option value="20000">20000</option>
   <option value="50000">50000</option>
    <option value="100000">100000</option>
    <option value="200000">200000 (chrome or edge)</option>
    <option value="500000">500000 (chrome or edge)</option>
    <option value="100000000">100000000 (chrome or edge)</option>
</select>
</td>


<td valign="top"><center>
<input type="button" value="Start" onclick="go(3)" 
 style="background-color:#ff4d4d; border-color:black; font-family:'Palatino Linotype','Serif'; border-radius: 10px;
 font-size:16px; font-weight:bold;"; /></center>
</td>
</tr>
</tbody>
</table>

 <div id="divPiDigits" style="background-color:#ffffbf;"></div>
</p>



</body>
</html>
